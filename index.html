<!DOCTYPE html>
<html>
<head>
	<title>Roll Initiative</title>
	<style>
		ol {
			list-style-type: none;
			padding: 10px;
		}

		ol li {
			padding: 8px 8px;
			margin: 2px;
			border: 2px solid #000000;
			text-align: center;
			vertical-align: center;
		}

		ol li.current-entity {
			border: 4px solid #000000;
		}

		ol li.full-health {
			background-color: #FF0800;
		}

		ol li.mid-health {
			background-color: #CC0000;
		}

		ol li.low-health {
			background-color: #B31B1B;
		}

		ol li.rlc {
			background-color: #960018
		}

		ol li.dead {
			background-color: #585858;
		}
	</style>
</head>
<body>
	<h1>Roll Initiative</h1>
	<p>Round: <div id="round"></div></p>
	<p>Entities: </p>
	<ol id="entities"></ol>
	<script type="text/javascript">
		var events = new EventSource("/data", {
			headers: {
				'Content-Type': 'text/event-stream',
				'Cache-Control': 'no-cache',
				'Connection': 'keep-alive'
			},
		});

		var entities = document.getElementById("entities");

		events.onmessage = function(e) {
			var test = JSON.parse(e.data);
			console.log(test);
			round.innerHTML = test.round;

			while (entities.firstChild) {
				entities.removeChild(entities.lastChild);
			}

			for (var i in test.entities) {
				var entity = test.entities[i]
				if (entity.visible) {
					var entry = document.createElement("li");
					var img = document.createElement("img");
					var character_label = document.createElement("div");
					var health_label = document.createElement("div");
					var conditions_label = document.createElement("div");

					if (entity.type == "player") {
						console.log("Setting player image");
						img.src = "data:image/png;base64," + entity.img_url;
						img.width = 128;
						img.height = 128;
					} else {
						console.log("Setting monster image");
						img.src = entity.img_url;
						img.width = 128;
						img.height = 128;
					}

					character_label.appendChild(document.createTextNode("\t" + entity.name + "\t"));

					if (i == test.current_entity_index) {
						entry.classList.add('current-entity');
					}

					if ((entity.type == "player") || (entity.type == "NPC")) {
						health_label.appendChild(document.createTextNode(entity.health));
						health_label.appendChild(document.createTextNode("/"));
						health_label.appendChild(document.createTextNode(entity.max_health));
						if (entity.temp_health > 0) {
							health_label.appendChild(document.createTextNode("+"));
							health_label.appendChild(document.createTextNode(entity.temp_health));
						}
					} else {
						//If it's a monster display bloodied, regretting life choices, etc.
						if (entity.health == entity.max_health) {
							health_label.appendChild(document.createTextNode("Healthy"));
							entry.classList.add('full-health');
						} else if (entity.health == 0) {
							health_label.appendChild(document.createTextNode("Defeated"));
							entry.classList.add('dead');
						} else if (entity.health <= 10) {
							health_label.appendChild(document.createTextNode("Regretting life choices..."));
							entry.classList.add('rlc');
						} else if (entity.health <= (entity.max_health / 2)) {
							health_label.appendChild(document.createTextNode("Bloodied"));
							entry.classList.add('low-health');
						} else {
							health_label.appendChild(document.createTextNode("Hurt"));
							entry.classList.add('mid-health');
						}
					}

					for (index in entity.conditions) {
						conditions_label.appendChild(document.createTextNode(entity.conditions[index]));
						conditions_label.appendChild(document.createTextNode("\n"));
					}

					entry.appendChild(img);
					entry.appendChild(character_label);
					entry.appendChild(health_label);
					entry.appendChild(conditions_label);

					entities.appendChild(entry);
				}
			}
		};
	</script>
</body>
</html>
